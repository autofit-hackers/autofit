<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/src/assets/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
    <title>Vite App</title>
  </head>
  <body>
    <div id="root">
      <div class="bd-toc-item">
        <h2 class="h3 pl-4">Demos</h2>
      </div>
      <!-- <ul class="nav bd-sidenav">
        <li>
          <a href="src\BodyTrack2d.html" target="viewer">body tracking (2D on color feed)</a>
        </li>
      </ul> -->
    </div>
    <script type="module" src="/src/main.tsx"></script>
    <script>
      {
        const { remote } = require('electron');

        const $viewer = document.getElementById('viewer');
        let webview = false;
        const demoLinks = Array.from(document.querySelectorAll('[target="viewer"]'));

        const timeOut = (ms) => {
          return new Promise((resolve) => {
            setTimeout(() => resolve(), ms);
          });
        };

        const loadDemo = async (url) => {
          const previousWebviewNeedsCleanup = webview !== false;
          if (previousWebviewNeedsCleanup) {
            if (!webview.getWebContentsId) {
              await new Promise((resolve) => {
                const onDomReady = () => {
                  resolve();
                  webview.removeEventListener('dom-ready', onDomReady);
                };
                webview.addEventListener('dom-ready', onDomReady);
              });
            }
            console.log('get web contents');
            const webContents = remote.webContents.fromId(webview.getWebContentsId());
            console.log(webContents);
            if (webContents) {
              await new Promise((resolve) => {
                webContents.once('ipc-message', (event, channel) => {
                  // kinect is closed now, load the next demo
                  resolve();
                });
                webContents.send('close-kinect');
              });
            }
            $viewer.removeChild(webview);
            webview = false;
          }

          webview = document.createElement('webview');
          webview.style.width = '100%';
          webview.style.height = '100%';
          webview.setAttribute('nodeintegration', true);
          webview.setAttribute('preload', './demo-preload.js');
          $viewer.appendChild(webview);

          webview.src = url;
        };
        loadDemo(demoLinks[0].href);

        demoLinks.forEach((link) => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            loadDemo(link.href);
          });
        });
      }
    </script>
  </body>
</html>
